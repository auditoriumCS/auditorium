<script src="/assets/sparklines.js"></script>
<div ng-app ng-controller="UserViewCtrl">
<h2> <%= @event.event_type.capitalize  %> on <%= @event.beginDate %> </h2>

<div class="row">
	

		<h3> Description </h3>
		<table class="show_table">
			<tr class="show_tr">
				
				<td class="show_td"><h3><%= @event.course.name %></h3></td>
			</tr>
			<tr class="show_tr">
				<td class="show_td"> <strong>Tutor</strong> </td>
				<td><%= @event.tutor.full_name  %></td>
			</tr>
			<tr class="show_tr">
				<td class="show_td"> <strong>Weekday</strong> </td>
				<td><%= @event.weekday %> in <%= @event.week %> </td>
			</tr>
			<tr class="show_tr">
				<td class="show_td"> <strong>Date</strong> </td>
				<td>
					<% if @event.beginDate == @event.endDate %>
  						<%= @event.beginDate %>
					<% else %>
  						<%= "from #{@event.beginDate} to #{@event.endDate}" %> 
					<% end %>
				</td>
			</tr>
			<tr class="show_tr">
				<td class="show_td"> <strong>Place</strong> </td>
				<td><%= @event.building %> <%= @event.room %></td>
			</tr>
			<tr class="show_tr">
				<td class="show_td"> <strong>Website</strong> </td>
				<td><%= @event.url %></td>
			</tr>
			
							
			
		</table>
		<table>
		<tr>
		<% if can? :manage, @course%>

    				<td class="show_btn"><%= link_to content_tag('span', ' Add new event', :class=> 'icon-plus'), new_event_path()  %></td>
    				<td class="show_btn"><%= link_to content_tag('span', ' edit event', :class=>'icon-edit'), edit_event_path(@event) %></td>
    				<td class="show_btn"><%= link_to content_tag('span', ' delete event', :class=>'icon-trash'), @event, confirm: 'Are you sure that you want to delete this event?', method: :delete %></td>
    				<td class="show_btn"><%= link_to 'All events', events_path %></td>
					<td class="show_btn"><%= link_to "Go to all Courses", courses_path %></td>
					<td class="show_btn" id="create_room"><a href="javascript:void(0)">Start Chat</a></td>
		<% end %>
		</tr>
		</table>
      <!-- end of span4 or span12 -->


  </div>  <!-- end of row -->


<h3>Polls</h3>



<% if can? :manage, @course %>
	<div class="pull-right">
		<%= link_to content_tag('span', 'add new poll', :class=>'icon-plus') , new_poll_path  %> 
	</div>
<% end %>

<% if @event.polls.count == 0 %>
	<p> no polls yet </p>
<% end %>

<h3>Feedback</h3>
<div id="mood">
	Geschwindigkeit 

	<div class="prof-control" id="speed">
		<span class="back"></span>
		<span class="left" ng-style="{width: (speed.down/2) +'%'}"></span>
		<span class="right" ng-style="{width: (speed.up/2) +'%'}"></span>
		<span class="center"></span>
		<span class="prof-control-ammount-left" >
			{{speed.down}} %
		</span>
		<span class="prof-control-ammount-right">
			{{speed.up}} %
		</span>
	</div>

	Lautstärke

	<div class="prof-control" id="volume">
		<span class="back"></span>
		<span class="left" ng-style="{width: (volume.down/2) +'%'}"></span>
		<span class="right" ng-style="{width: (volume.up/2) +'%'}"></span>
		<span class="center"></span>
		<span class="prof-control-ammount-left" >
			{{volume.down}} %
		</span>
		<span class="prof-control-ammount-right">
			{{volume.up}} %
		</span>
	</div>

	Verständlichkeit

	<div class="prof-control" id="comprehensibility">
		<span class="back"></span>
		<span class="left" ng-style="{width: (comprehensibility.down/2) +'%'}"></span>
		<span class="right" ng-style="{width: (comprehensibility.up/2) +'%'}"></span>
		<span class="center"></span>
		<span class="prof-control-ammount-left" >
			{{comprehensibility.down}} %
		</span>
		<span class="prof-control-ammount-right">
			{{comprehensibility.up}} %
		</span>
	</div>
</div>
<style type="text/css">
	/* prof controls TODO @shirin: plz outsource in some css file; */
	#mood {
		position:relative;
	}
	
	#mood .prof-control {
		position: relative;
		height:40px;
	}
	
	#mood .btn-left {
		position: absolute;
		padding: 0 9px;
		line-height: 16px;
		top: 17px;
		left:0px;
		width: 50%;
		text-align: left;
		border-top-left-radius: 0;
		border-top-right-radius: 0;
		border-bottom-right-radius: 0;
	} 

	#mood .btn-right {
		position: absolute;
		padding: 0 9px;
		line-height: 16px;
		right:0px;
		top: 17px;
		width: 50%;
		text-align: right;
		border-top-right-radius: 0;
		border-top-left-radius: 0;
		border-bottom-left-radius: 0;
	} 
	
	

	#mood .prof-control-ammount-left {
		position: absolute;
		line-height: 16px;
		color: #fff;
		left: 20px;
	}

	#mood .prof-control-ammount-right {
		position: absolute;
		line-height: 16px;
		color: #fff;
		right: 20px;
	}



	#mood .back {
		position: absolute;
		width: 100%;
		height: 17px;
		background-color: rgba(200,200,200,0.666);
		border-radius: 4px;
		border-bottom-right-radius: 0;
		border-bottom-left-radius: 0;
	}

	#mood .right {
		position: absolute;
		height: 10px;
		top: 3px;
		left:50%;
		background-color: #0f0;
		-webkit-transition: width 1s ease-in-out;
			    -moz-transition: width 1s ease-in-out;
			    -o-transition: width 1s ease-in-out;
			    transition: width 1s ease-in-out;
	}
	

	#mood .left {
		position: absolute;
		height: 10px;
		top: 3px;
		right:50%;
		background-color: #f00;
		-webkit-transition: width 1s ease-in-out;
			    -moz-transition: width 1s ease-in-out;
			    -o-transition: width 1s ease-in-out;
			    transition: width 1s ease-in-out;
	}

	#mood .center {
		position: absolute;
		height: 17px;
		width: 2px;
		right: 50%;
		margin-right: -1px;
		background-color: #fff;
	}

</style>
<div class="row" ng-repeat="p in results">
	<div class="span8" id="polls"> 
		<h2>Frage:</h2> 
		<div class="btn-group">
		  <button ng-click="toggleVisibilityOfPoll(p.id)" class="btn" ng-class="p.poll_enabled && 'icon-lock' || 'icon-unlock'" > {{p.poll_enabled && 'disable' || 'enable'}}</button>
		  <button ng-click="editPoll(p.id)" class="btn icon-edit"> edit</button>
		  <button ng-click="deletePoll(p.id)" class="btn btn-danger icon-trash"> delete</button>
		</div>
		<div>
			<h3>{{p.text}}</h3>
			<div ng-repeat="c in p.choices">
				{{$index}}. {{c.text}}
			</div>
			
		</div>
	</div>
	<div class="span2" id="results">
		<h2>Ergebnis:</h2>
		<button ng-click="toggleVisibilityOfResult(p.id)" class="btn" ng-class="p.result_enabled && 'icon-lock' || 'icon-unlock'" > {{p.result_enabled && 'disable' || 'enable'}}</button>
		<div>
			<span class="sparklines pull-right" values="{{p.pie}}" decisive="{{p.decisive}}"></span>			
		</div>

	</div>
</div>
<!--
	<% @event.polls.each do |poll| %>

		<div class="row">
			<div class="span6">
					<h4><%= poll.questiontext %></h4>
					<% if can? :manage, @course %>
						<div class="pull-right">
							
							<% if poll.poll_enabled == true %>
    						<%= link_to content_tag('span', 'disable', :class=> 'icon-lock'), toggle_visibility_of_poll_path(poll) %>
    						<% else %>
    						<%= link_to content_tag('span', 'enable', :class=> 'icon-unlock'), toggle_visibility_of_poll_path(poll) %>    						
    						<% end %>

							<%= link_to content_tag('span', 'edit', :class=>'icon-edit') , edit_poll_path(poll)  %> &nbsp; &nbsp;
							<%= link_to content_tag('span', 'delete', :class=>'icon-trash'), poll, confirm: 'Are you sure that you want to delete this poll?', method: :delete %>
						</div>
					<% end %>
					<ol type="a">
					<% poll.choices.each do |choice| %>
						<li><%= choice.answertext %></li>
					<% end %>
				</ol>
			</div>
			<div class="span6">
				<h4> Result </h4>
				<% if can? :manage, @course %>
						<div class="pull-right">
							<% if poll.result_enabled == true %>
    						<%= link_to content_tag('span', 'disable', :class=> 'icon-lock'), toggle_visibility_of_result_path(poll) %>
    						<% else %>
    						<%= link_to content_tag('span', 'enable', :class=> 'icon-unlock'), toggle_visibility_of_result_path(poll) %>    						
    						<% end %>

						</div>
				<% end %>
				<div class="poll-result" id='<%= "poll_result_#{poll.id}" %>'>

				</div>
			</div>
		</div> 
	<% end %>   -->
<div id="loginDialog">
	<div id="login_user"><label>User:</label><input type="text" id="jid"></div>
	<div id="login_pw"><label>Password:</label> <input type="password" id="password"></div>
	<div id="login_nick"><label>Nickname:</label> <input type="text" id="nickname"></div>
</div>
</div>
<script>
	function UserViewCtrl($scope, $http, $timeout){
		$scope.rtcInterval = 1000;
		$scope.pform;
		$scope.eid = <%= @event.id %>
		$http.defaults.headers.common['X-CSRF-Token'] = jQuery('meta[name=csrf-token]').attr('content');

		$scope.url = {}
		$scope.url.rtc = $scope.eid+"/rtc.json";
		$scope.url.toggleVisibilityOfResult  = "/toggle_visibility_of_result";
		$scope.url.toggleVisibilityOfPoll  = "/toggle_visibility_of_poll";
		$scope.url.submitControl = $scope.eid+"/prof_control.json";
		$scope.url.logout = $scope.eid+"/logout.json";

		$scope.polls = {};
		$scope.results = [];
		$scope.activePoll = 0;
		$scope.activeResult = 0;
		$scope.pollslength = 0;

		$scope.slideId = "";

		$scope.speed = {
			up: 0,
			down : 0,
			canVote : true	
		}

		$scope.volume  = {
			up: 0,
			down : 0,
			canVote : true	
		}

		$scope.comprehensibility = {
			up: 0,
			down : 0,
			canVote : true		
		}

		window.onbeforeunload = function(){
			$http.post($scope.url.logout);
		}
		$scope.convertuuid = function(v){
			return v.substr(0,8)+"-"+v.substr(8,4)+"-"+v.substr(12,4)+"-"+v.substr(16,4)+"-"+v.substr(20,12);
		}

		$scope.toggleVisibilityOfResult = function(pid) {
			$http.get("/polls/"+$scope.convertuuid(pid)+ $scope.url.toggleVisibilityOfResult);
		}

		$scope.toggleVisibilityOfPoll = function(pid) {
			$http.get("/polls/"+$scope.convertuuid(pid)+ $scope.url.toggleVisibilityOfPoll);
		}

		$scope.deletePoll = function(pid) {
			if(confirm('are you sure you want to delete this poll?'))
				$http.delete("/polls/"+$scope.convertuuid(pid))
		}

		$scope.editPoll = function(pid){
			window.location.href = "/polls/"+$scope.convertuuid(pid)+"/edit";
		}

		$scope.submitPoll = function(cid,pid){
			var data = {}
			data.choice_id = cid;
			data.poll_id = pid;
			data.t_delta = Date.now() - $scope.polls[pid].t_start;
			$http.post($scope.url.submitPoll,data).then(function(s){
				var d = s.data;
				d.msg = s.data.msg;
				if(!d.is_correct){
					if($scope.polls[data.poll_id].messages == undefined)
						$scope.polls[data.poll_id].messages = [];
					$scope.polls[data.poll_id].messages.push(d.msg);
				} else {
					delete $scope.polls[data.poll_id];
					$scope.pollslength --;
					$scope.activePoll = $scope.activePoll % $scope.pollslength;
				}
					
			});
		}

		$scope.resHeight = function(i,a) {
			return (i==a)?"auto":"0px";
		}

		$scope.submitControl = function(which, val) {
			$scope[which].canVote = false;
			var data = {}
			data[which] = val;
			$http.post($scope.url.submitControl,data).then(function(s){
				
			});
		}

		$scope.incrementActivePoll = function () {
			$scope.activePoll = ($scope.activePoll + 1) % $scope.pollslength
		}

		$scope.decrementActivePoll = function() {
			$scope.activePoll = ($scope.pollslength + $scope.activePoll - 1) % $scope.pollslength

		}
		$scope.incrementActiveResult = function () {
			$scope.activeResult = ($scope.activeResult + 1) % $scope.results.length
		}

		$scope.decrementActiveResult = function() {
			$scope.activeResult = ($scope.results.length + $scope.activeResult - 1) % $scope.results.length
		}
		$scope.rtc = function() {
			$http.get($scope.url.rtc).then(function(s){
				$scope.results = s.data.poll_results;
				var idxs = {}
				$scope.pollslength = 0;
				angular.forEach(s.data.open_polls, function(v,k){
					idxs[v.id] = true;
					if($scope.polls[v.id] == undefined){
						$scope.polls[v.id] = v;
						$scope.polls[v.id].t_start = Date.now();
					}
						
				});
				angular.forEach($scope.polls, function(v,k){
					if(idxs[k]==undefined)
						delete $scope.polls[k];
					else $scope.pollslength++
				});
				s.data.prof_speed = Math.round((s.data.prof_speed / s.data.viewers)*100)
				s.data.prof_volume =  Math.round((s.data.prof_volume / s.data.viewers)*100)
				s.data.prof_comprehensibility =  Math.round((s.data.prof_comprehensibility / s.data.viewers)*100)

				// rt prof feedback
				$scope.speed.up = (s.data.prof_speed > 0)?s.data.prof_speed :0;
				$scope.speed.down = (s.data.prof_speed < 0)?s.data.prof_speed * -1 :0;
				$scope.volume.up = (s.data.prof_volume > 0)?s.data.prof_volume :0;
				$scope.volume.down = (s.data.prof_volume < 0)?s.data.prof_volume * -1 :0;
				$scope.comprehensibility.up = (s.data.prof_comprehensibility > 0)?s.data.prof_comprehensibility :0;
				$scope.comprehensibility.down = (s.data.prof_comprehensibility < 0)?s.data.prof_comprehensibility * -1 :0;


				$scope.comprehensibility.canVote = s.data.prof_comprehensibility_canVote;
				$scope.speed.canVote = s.data.prof_speed_canVote;
				$scope.volume.canVote = s.data.prof_volume_canVote;

				angular.forEach($scope.results, function(v,k){
					v.pie = [];
					var pieValues = [];
					var pieColors = [];
					v.decisive = false;
					var firstCorrect = v.choices[0].correct;
					
					for(c in v.choices) if(v.choices[c].text){
						if(v.total > 0){
						pieValues.push({correct:v.choices[c].correct,value:v.choices[c].count});
						if(firstCorrect!=v.choices[c].correct)
							v.decisive = true;
							}
					}
					
					
					if(v.total > 0)for(i in pieValues){
						if(v.decisive){
							var j = (pieValues[i].correct)?0:1;
							v.pie[j] =  (v.pie[j]==undefined)?pieValues[i].value:v.pie[j]+pieValues[i].value;
						} else {
							v.pie.push(pieValues[i].value)
						}
					}
					v.pie = v.pie.join(",")

				})
				$timeout(function() {
					jQuery(".sparklines").each(function(idx){
						var dec = (jQuery(this).attr("decisive")=="true")?true:false;
						jQuery(this).sparkline('html',{ width : '100', height : '100', type : 'pie', sliceColors:((dec)? ["#00ff00","#ff0000"] : undefined)})
					});
				}, 10);
				

				$timeout($scope.rtc,$scope.rtcInterval);
			});
		}
		$scope.rtc();


	}
</script>
<style>
.hidden{
    display: none;
}

#loginDialog{
	display:none;
}

header, #chatContainer, #inputContainer textarea:hover, #memberContainer ul#memberList li div.member {
	background: #eee;
}

header div#logout img#disconnect:hover, #memberContainer ul#memberList li div.member:hover, ul#feedback li:hover,
header div#stopIcon img#stop:hover, img#go {
    cursor: pointer;
}

header  img, #memberContainer ul#memberList li div.image  img {
    width: 100%;
    height: 100%;
}

/* Dialog Styles*/

div#loginDialog label {
    display: block;
}

textarea#pmMessage {
    width: 100%;
    height: 100%;
    resize: none;
}

/* END Dialog Styles*/
/* Header */

header {
	margin: 0 0 2% 0;
	padding: 2px 0 2px 0;
	width: auto;
    height: 35px;
}

header > div {
	float: left;
}

header div#icon, header div#logout, header div#stopIcon{
	height: 100%;
    width: 5%;
}

header div#avatar {
    width: 20%;
    margin: 10px 1% 0 1%;
}

header div#stopIcon img#stop {
	height: 35px;
 	max-width: 35px;
	padding: 2px;	
}

header div#status {
    width: 61%;
    margin: 10px 1% 0 1%;
}

header div#logout img#disconnect{
 	height: 25px;
 	max-width: 20px;
	float: right;
	padding: 5px;		
}

/* END Header */
/* Basic Layout */

#page {
    margin: 0 auto;
    width: 100%;
    height: 100%;
    min-width: 650px;
    min-height: 400px;
}

#chatContainer, #memberContainer {
    height: 70%;
    border: 1px solid #3B5998;
	overflow: auto;
	padding: 0.5%;
	margin-bottom: 1%;
}

#chatContainer {	
    width: auto;
    word-wrap: break-word;   
}

#memberContainer {
	margin-left: 25px;
    width: 220px;
    float: right;	
}

#inputContainer{
    clear: both;
    width: 100%;
	float: bottom;
}

#inputContainer{
    height: 10%;
}

#inputContainer textarea {
	width: 99%;
	height: 99%;
    border: thin solid #3B5998;
    border-radius: 10px;
    resize: none;
    overflow: auto;	
	padding: 0.5%;
}

/* END Basic Layout */
/* ChatContainer Elements */

#chatContainer div {
    font-size: 90%;
}

#chatContainer div.message {
    padding: 2px;
    margin: 8px;
    background: white;
}

#chatContainer div.message div.head {
    color: #3B5998;
    font-style:italic;
}

#chatContainer div.private div.body {
    background: #3B5998;
    color: white;
}

/* END ChatContainer Elements */
/* MemberContainer Elements */

#memberContainer ul#memberList {
    list-style-type: none;
    width: 100%;
    padding: 0;
    margin: 0;
}

#memberContainer ul#memberList li div.member {
    width: 100%;
	height: 30px;
    float: left;
    margin-bottom: 1.5%;
}

#memberContainer ul#memberList li div.image {
    float: left; 
    width: 15%; 
    height: 100%; 
    margin-right: 2%;
}

#memberContainer ul#memberList li div.nick {
    float: left;
    width: 83%;
	padding: 2% 0;
}

#memberContainer ul#memberList li div.member:hover {
    background-color: white;
}

.ui-dialog .ui-dialog-titlebar-close{
	margin: -12px 0 0 0;
	height: auto;
}


/* END MemberContainer Elements */

</style>