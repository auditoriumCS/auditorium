<p id="notice"><%= notice %></p>
<script src="/assets/sparklines.js"></script>
<script>
function actualize(eId) {
	var url = "/poll_results/refresh/"+eId;
	jQuery.get(
	url,
	{},
	function(s){
		var r = s;
		for(q in r){
			if(r[q].text){
				var snippet = "";
				var pie = [];
				var pieValues = [];
				var pieColors = [];
				var decisive = false;
				var firstCorrect = r[q].choices[0].correct;
				
				for(c in r[q].choices) if(r[q].choices[c].text){
					if(r[q].total > 0){
					pieValues.push({correct:r[q].choices[c].correct,value:r[q].choices[c].count});
					if(firstCorrect!=r[q].choices[c].correct)
						decisive = true;
						}

					snippet += '<div class="poll-result">';
					snippet += '</div>';
				}
				
				
				if(r[q].total > 0)for(i in pieValues){
					if(decisive){
						var j = (pieValues[i].correct)?0:1;
						pie[j] =  (pie[j]==undefined)?pieValues[i].value:pie[j]+pieValues[i].value;
					} else {
						pie.push(pieValues[i].value)
					}
				}
				if(r[q].total > 0)
					snippet +=  '<span class="sparklines" values="'+pie.join(",")+'" decisive="'+decisive+'"></span>'
				jQuery("#poll_result_"+q).html(snippet);
				
			}
		}
		jQuery(".sparklines").each(function(idx){
			var dec = (jQuery(this).attr("decisive")=="true")?true:false;
			jQuery(this).sparkline('html',{ width : '100', height : '100', type : 'pie', sliceColors:((dec)? ["00ff00","#ff0000"] : undefined)})
		});
	});
	setTimeout(function(){actualize(eId)},1500);
}
jQuery(function(){
	actualize(<%=@event.id%>);
});
</script>

<h2>
	<%= @event.event_type.camelize %> on <%= @event.beginDate %>
</h2>

<div class="row">

<% if can? :manage, @course %>
    <div class="span4">
<% else %>
    <div class="span12">
<% end %>
    		<h3> Description </h3>
    		<table class="table">
    			<tr>
    				<td> <strong>Kurs</strong> </td>
    				<td><%= @event.course.name %></td>
    			</tr>
    			<tr>
    				<td> <strong>Tutor</strong> </td>
    				<td><%= @event.tutor.full_name  %></td>
    			</tr>
    			<tr>
    				<td> <strong>Weekday</strong> </td>
    				<td><%= @event.weekday %> in <%= @event.week %> </td>
    			</tr>
    			<tr>
    				<td> <strong>Date</strong> </td>
    				<td>
    					<% date = '#{@event.beginDate} to #{@event.endDate}' %>
    					<%= (@event.beginDate == @event.endDate) ? @event.beginDate : date %>
    				</td>
    			</tr>
    			<tr>
    				<td> <strong>Place</strong> </td>
    				<td><%= @event.building %> <%= @event.room %></td>
    			</tr>
    			<tr>
    				<td> <strong>Website</strong> </td>
    				<td><%= @event.url %></td>
    			</tr>
    		</table>
    </div>

<% if can? :manage, @course %>
    <div class="span4">
    	<h3> Jump To </h3>
    	<a href="#polls">Polls</a><br>
    	<a href="#triggers">Triggers</a>
    		
    </div>
    <div class="span4">
    	<h3> Possible Actions </h3>
    	<!-- btn btn-small btn-block btn-primary -->
    	<!-- enable event -->
    	<%= link_to content_tag('span', ' Add new event', :class=> 'icon-plus'), new_event_path(), :class => 'btn btn-small btn-block'  %>
    	<%= link_to content_tag('span', ' edit event', :class=>'icon-edit'), edit_event_path(@event), :class => 'btn btn-small btn-block'  %>
    	<%= link_to content_tag('span', ' delete event', :class=>'icon-trash'), @event, confirm: 'Are you sure that you want to delete this event?', method: :delete, :class => 'btn btn-small btn-block btn-danger' %>

    </div>
<% end %>

</div>

<a name="polls"></a>
<h3>Polls</h3>
	<div class="pull-right">
		<%= link_to content_tag('span', 'add', :class=>'icon-add') , new_poll_path  %> 
	</div>
<% if @event.polls.count == 0 %>

	<p> no polls yet </p>

<% end %>

<% @event.polls.each do |poll| %>

<div class="row">
	<div class="span6">
			<h4><%= poll.questiontext %></h4>
			<div class="pull-right">
				<!-- enable -->
				<%= link_to content_tag('span', 'edit', :class=>'icon-edit') , edit_poll_path(poll)  %> &nbsp; &nbsp;
				<%= link_to content_tag('span', 'delete', :class=>'icon-trash'), poll, confirm: 'Are you sure that you want to delete this poll?', method: :delete %>
			</div>
			<ol type="a">
			<% poll.choices.each do |choice| %>
				<li><%= choice.answertext %></li>
			<% end %>
		</ol>
	</div>
	<div class="span6">
		<div class="poll-result" id='<%= "poll_result_#{poll.id}" %>'>

		</div>
	</div>
</div>

<% end %>


<a name="triggers"></a>
<h3>Triggers</h3>

<p> no triggers yet </p>